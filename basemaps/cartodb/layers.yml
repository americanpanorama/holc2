labels:
  sql: |
    SELECT city, state, 'north' as placement, ST_Translate(ST_Transform(ST_SetSRID(ST_MakePoint(looplng,looplat),4326),3857)::geometry, 0, 47500)::geometry as the_geom_webmercator FROM  holc_ads where city = any('{Los Angeles, Spokane, Tampa, Miami, Seattle, Portland, Sacramento, Jacksonville, Mobile, New Orleans, Birmingham, Atlanta, Augusta, Knoxville, Macon, Richmond, Lynchburg, Greensboro, Wichita, Stockton, Oakland, Fresno, San Diego, Austin, Dallas, Oklahoma City, St.Joseph, East St. Louis, Decatur, Evansville, Terre Haute,  Louisville, Lima, Muncie, Minneapolis, Duluth, Oshkosh, Madison, Rockford, Milwaukee Co., Chicago, Aurora, SouthBend, Muskegon, Battle Creek, Bay City, Toledo, Portsmouth, Charleston,Cleveland, Warren, Pittsburgh, Altoona, Erie, Niagara Falls, Syracuse, Utica, Schenectady, Rochester, Poughkeepsie, East Hartford, Philadelphia, Baltimore, Denver, Chattanooga, Lexington}'::text[]) or (city = 'Springfield' and state='OH') union SELECT city, state, 'south' as placement, ST_Translate(ST_Transform(ST_SetSRID(ST_MakePoint(looplng,looplat),4326),3857)::geometry, 0, -45000)::geometry as the_geom_webmercator FROM  holc_ads where city = any('{Tacoma, St. Petersburg, Montgomery, Charlotte, Charlestown, Norfolk, Asheville, Durham, Greater Kansas City, San Jose, Hamilton, Lake County Gary, Indianapolis, Canton, Johnstown, Albany, Camden, Fort Wayne, Columbus, Wheeling}'::text[]) or (city = 'Springfield' and state='IL') union SELECT city, state, 'southwest' as placement, ST_Translate(ST_Transform(ST_SetSRID(ST_MakePoint(looplng,looplat),4326),3857)::geometry, -30000, -30000)::geometry as the_geom_webmercator FROM  holc_ads where city = any('{San Francisco, Joliet}'::text[]) union SELECT city, state, 'southeast' as placement, ST_Translate(ST_Transform(ST_SetSRID(ST_MakePoint(looplng,looplat),4326),3857)::geometry, 30000, -30000)::geometry as the_geom_webmercator FROM  holc_ads where city = any('{New Haven, New Britain, Lake County Calumet/Hammond}'::text[]) union SELECT city, state, 'west' as placement, ST_Translate(ST_Transform(ST_SetSRID(ST_MakePoint(looplng,looplat),4326),3857)::geometry, -40000, 0)::geometry as the_geom_webmercator FROM  holc_ads where city = any('{Roanoke, Saginaw, Flint, Pontiac, Detroit, Akron, St.Petersburg, Essex County, Dayton, Kalamazoo}'::text[]) union SELECT city, state, 'east' as placement, ST_Translate(ST_Transform(ST_SetSRID(ST_MakePoint(looplng,looplat),4326),3857)::geometry, 40000, 0)::geometry as the_geom_webmercator FROM  holc_ads where city = any('{Troy, Atlantic City, Kenosha, New Castle}'::text[]) union SELECT city, state, 'northeast' as placement, ST_Translate(ST_Transform(ST_SetSRID(ST_MakePoint(looplng,looplat),4326),3857)::geometry, 25000, 35000)::geometry as the_geom_webmercator FROM  holc_ads where city = any('{Newport News, Grand Rapids, Youngstown, Racine}'::text[]) union SELECT city, state, 'northwest' as placement, ST_Translate(ST_Transform(ST_SetSRID(ST_MakePoint(looplng,looplat),4326),3857)::geometry, -25000, 35000)::geometry as the_geom_webmercator FROM  holc_ads where city = any('{Winston Salem, Hudson County, Lorain, Stamford\, Darien\, and New Canaan}'::text[]) union SELECT 'Greater Boston' as city, state, 'east' as placement, ST_Translate(ST_Transform(ST_SetSRID(ST_MakePoint(looplng,looplat),4326),3857)::geometry, 40000, 0)::geometry as the_geom_webmercator FROM  holc_ads where city = any('{Boston}'::text[]) union SELECT 'Five Boroughs of New York' as city, state, 'southeast' as placement, ST_Translate(ST_Transform(ST_SetSRID(ST_MakePoint(looplng,looplat),4326),3857)::geometry, 60000, -30000)::geometry as the_geom_webmercator FROM  holc_ads where city = any('{Brooklyn}'::text[])
cityMarkers:
  sql: |
    with raw_area as (SELECT 30000 as bufferdist, holc_ads.city_id as ad_id, city, looplat::numeric, looplng::numeric, sum(st_area(digitalscholarshiplab.holc_polygons.the_geom_webmercator)) as total_area, sum(CASE WHEN holc_grade = 'A' THEN st_area(digitalscholarshiplab.holc_polygons.the_geom_webmercator) ELSE 0 END) as area_a, sum(CASE WHEN holc_grade = 'B' THEN st_area(digitalscholarshiplab.holc_polygons.the_geom_webmercator) ELSE 0 END) as area_b, sum(CASE WHEN holc_grade = 'C' THEN st_area(digitalscholarshiplab.holc_polygons.the_geom_webmercator) ELSE 0 END) as area_c, sum(CASE WHEN holc_grade = 'D' THEN st_area(digitalscholarshiplab.holc_polygons.the_geom_webmercator) ELSE 0 END) as area_d, ST_Transform(ST_SetSRID(ST_MakePoint(looplng,looplat),4326),3857)::geometry as the_point FROM digitalscholarshiplab.holc_polygons right join holc_ads on digitalscholarshiplab.holc_polygons.ad_id = holc_ads.city_id and city_id is not null group by city_id, city, looplat, looplng), buffers as (select *, ST_Transform(ST_Buffer(the_point, sqrt(bufferdist^2 * area_d / total_area) )::geometry ,3857 ) as buffer_d, ST_Transform(ST_Buffer(the_point, sqrt(bufferdist^2 * (area_c + area_d) / total_area) )::geometry ,3857 ) as buffer_c, ST_Transform(ST_Buffer(the_point, sqrt(bufferdist^2 * (area_b + area_c + area_d) / total_area) )::geometry ,3857 ) as buffer_b, ST_Transform(ST_Buffer(the_point, bufferdist )::geometry ,3857 ) as buffer_a from raw_area ) SELECT ST_Difference(buffer_a, buffer_b) as the_geom_webmercator, 'a' as grade from buffers union all select ST_Difference(buffer_b, buffer_c) as the_geom_webmercator, 'b' as grade from buffers union all select ST_Difference(buffer_c, buffer_d) as the_geom_webmercator,  'c' as grade from buffers union all select buffer_d as the_geom_webmercator, 'd' as grade from buffers union all select ST_Transform(ST_Buffer(the_point, bufferdist )::geometry ,3857) as the_geom_webmercator, null as grade from raw_area where total_area is null